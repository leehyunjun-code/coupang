<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëŒ€ì‹œë³´ë“œ</title>
  <link rel="stylesheet" href="/styles.css">
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <meta name="apple-mobile-web-app-title" content="ì¿ íŒ¡ì•ŒëŒ">
  <link rel="apple-touch-icon" href="/icon-192x192.png">
</head>
<body>
  <div class="container">
    <h1>ì£¼ë¬¸ ì•ŒëŒ</h1>
    
    <div id="userInfo"></div>
    
    <button onclick="requestNotificationPermission()">ğŸ”” ì•Œë¦¼ ê¶Œí•œ ìš”ì²­</button>
    <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    <button onclick="loadOrders()">ì£¼ë¬¸ ìƒˆë¡œê³ ì¹¨</button>

    <h2 style="margin-top: 30px;">ì˜¤ëŠ˜ ì£¼ë¬¸ (<span id="orderCount">0</span>ê±´)</h2>
    <div id="orderList">ë¡œë”© ì¤‘...</div>
  </div>

  <script>
    const user = JSON.parse(localStorage.getItem('user'));
    let previousOrderIds = new Set();
    let isFirstLoad = true;

    if (!user) {
      location.href = 'index.html';
    }

    document.getElementById('userInfo').innerHTML = `
      <div class="message success">
        ${user.name}ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤!
      </div>
    `;

    // Service Worker ë“±ë¡
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker ë“±ë¡ ì„±ê³µ', reg))
        .catch(err => console.log('Service Worker ë“±ë¡ ì‹¤íŒ¨', err));
    }

    // ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        alert('ì´ ë¸Œë¼ìš°ì €ëŠ” ì•Œë¦¼ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
      }

      const permission = await Notification.requestPermission();
      
      if (permission === 'granted') {
        alert('ì•Œë¦¼ ê¶Œí•œì´ í—ˆìš©ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰');
        // í…ŒìŠ¤íŠ¸ ì•Œë¦¼
        showNotification('ì•Œë¦¼ í…ŒìŠ¤íŠ¸', 'ìƒˆ ì£¼ë¬¸ì´ ì˜¤ë©´ ì´ë ‡ê²Œ ì•Œë¦¼ì´ ì˜µë‹ˆë‹¤!');
      } else {
        alert('ì•Œë¦¼ ê¶Œí•œì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
      }
    }

    // ë¡œì»¬ ì•Œë¦¼ í‘œì‹œ
    function showNotification(title, body) {
      if ('serviceWorker' in navigator && 'Notification' in window) {
        if (Notification.permission === 'granted') {
          navigator.serviceWorker.ready.then(reg => {
            reg.showNotification(title, {
              body: body,
              icon: '/icon-192x192.png',
              badge: '/icon-192x192.png',
              vibrate: [200, 100, 200],
              tag: 'order-notification',
              requireInteraction: false
            });
          });
        }
      }
    }

    function logout() {
      // ìë™ ë¡œê·¸ì¸ ì •ë³´ ì‚­ì œ
      localStorage.removeItem('user');
      localStorage.removeItem('autoLogin');
      localStorage.removeItem('savedUsername');
      localStorage.removeItem('savedPassword');
      location.href = 'index.html';
    }

    async function loadOrders() {
      try {
        const res = await fetch(`/api/orders/recent?userId=${user.id}`);
        const data = await res.json();
        
        if (data.orders && data.orders.length > 0) {
          // ì£¼ë¬¸ ê°œìˆ˜ ì—…ë°ì´íŠ¸
          document.getElementById('orderCount').textContent = data.orders.length;

          // ìƒˆ ì£¼ë¬¸ ì²´í¬ (ì²« ë¡œë“œê°€ ì•„ë‹ ë•Œë§Œ)
          if (!isFirstLoad) {
            const currentOrderIds = new Set(data.orders.map(o => o.orderId));
            
            // ì´ì „ì— ì—†ë˜ ì£¼ë¬¸ ì°¾ê¸°
            const newOrders = data.orders.filter(o => !previousOrderIds.has(o.orderId));
            
            if (newOrders.length > 0) {
              // ìƒˆ ì£¼ë¬¸ ì•Œë¦¼
              const totalAmount = newOrders.reduce((sum, order) => {
                return sum + order.orderItems.reduce((itemSum, item) => {
                  return itemSum + (parseFloat(item.unitSalesPrice) * item.salesQuantity);
                }, 0);
              }, 0);
              
              showNotification(
                `ğŸ‰ ìƒˆ ì£¼ë¬¸ ${newOrders.length}ê±´!`,
                `ì´ ${totalAmount.toLocaleString()}ì› / ${newOrders.map(o => o.orderItems[0].productName).join(', ')}`
              );
            }
            
            previousOrderIds = currentOrderIds;
          } else {
            // ì²« ë¡œë“œ ì‹œ í˜„ì¬ ì£¼ë¬¸ ID ì €ì¥
            previousOrderIds = new Set(data.orders.map(o => o.orderId));
            isFirstLoad = false;
          }

          // ì£¼ë¬¸ ëª©ë¡ í‘œì‹œ
          let html = '';
          let totalRevenue = 0;

          data.orders.forEach(order => {
            const paidDate = new Date(order.paidAt).toLocaleString('ko-KR');
            
            order.orderItems.forEach(item => {
              const itemTotal = parseFloat(item.unitSalesPrice) * item.salesQuantity;
              totalRevenue += itemTotal;
              
              html += `
                <div style="border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 4px;">
                  <p><strong>ì£¼ë¬¸ë²ˆí˜¸:</strong> ${order.orderId}</p>
                  <p><strong>ìƒí’ˆ:</strong> ${item.productName}</p>
                  <p><strong>ìˆ˜ëŸ‰:</strong> ${item.salesQuantity}ê°œ</p>
                  <p><strong>ë‹¨ê°€:</strong> ${parseFloat(item.unitSalesPrice).toLocaleString()}ì›</p>
                  <p><strong>ì´ì•¡:</strong> ${itemTotal.toLocaleString()}ì›</p>
                  <p><strong>ê²°ì œì¼:</strong> ${paidDate}</p>
                </div>
              `;
            });
          });

          html = `<div style="background: #f0f0f0; padding: 10px; margin-bottom: 15px; border-radius: 4px;">
            <strong>ì˜¤ëŠ˜ ì´ ë§¤ì¶œ:</strong> ${totalRevenue.toLocaleString()}ì›
          </div>` + html;

          document.getElementById('orderList').innerHTML = html;
        } else {
          document.getElementById('orderCount').textContent = '0';
          document.getElementById('orderList').innerHTML = '<p>ì˜¤ëŠ˜ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
      } catch (error) {
        document.getElementById('orderList').innerHTML = `<p>ì˜¤ë¥˜: ${error.message}</p>`;
      }
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì•Œë¦¼ ê¶Œí•œ í™•ì¸
    if (Notification.permission === 'default') {
      setTimeout(() => {
        if (confirm('ìƒˆ ì£¼ë¬¸ ì•Œë¦¼ì„ ë°›ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          requestNotificationPermission();
        }
      }, 2000);
    }

    // ì²« ë¡œë“œ
    loadOrders();
    
    // 1ë¶„ë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
    setInterval(loadOrders, 60000);
  </script>
</body>
</html>